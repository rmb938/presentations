services:
  warpstream-agent-kafka:
    image: public.ecr.aws/warpstream-labs/warpstream_agent:latest
    restart: unless-stopped
    command:
      - agent
    env_file: .env/warpstream-agent-kafka
    secrets:
      - gcp_service_account_key
    ports:
      - 9092:9092
  bento:
    image: ghcr.io/warpstreamlabs/bento
    restart: unless-stopped
    volumes:
      - ./bento.yaml:/bento.yaml
    environment:
      REDIS_HOST: redis
    depends_on:
      redis:
        condition: service_healthy
  # warpstream-agent-tableflow:
  #   image: public.ecr.aws/warpstream-labs/warpstream_agent:unstable-timestampfrommessagevalue
  #   restart: unless-stopped
  #   command:
  #     - agent
  #   env_file: .env/warpstream-agent-tableflow
  #   secrets:
  #     - gcp_service_account_key
  redis:
    image: docker.io/library/redis:8
    restart: unless-stopped
    command:
      # Save a snapshot of the DB every 60 seconds if at least 1 write operation was performed
      - redis-server
      - --save
      - "60"
      - "1"
      - --loglevel warning
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    volumes:
      - redis:/data

secrets:
  gcp_service_account_key:
    file: .secrets/rmb-lab-cdc3ab9f96b6.json

volumes:
  redis: {}
